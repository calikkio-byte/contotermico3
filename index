<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulatore Conto Termico 3.0 - Arquati Eco Living</title>
    <style>
        :root { --primary: #27ae60; --secondary: #2c3e50; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: #333; line-height: 1.6; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        h1 { color: var(--secondary); text-align: center; border-bottom: 3px solid var(--primary); padding-bottom: 10px; }
        .steps-indicator { display: flex; justify-content: space-between; margin-bottom: 30px; font-weight: bold; font-size: 0.85em; color: #999; }
        .steps-indicator div.active { color: var(--primary); border-bottom: 2px solid var(--primary); }
        .step { display: none; }
        .step.active { display: block; }
        label { display: block; margin: 20px 0 5px; font-weight: 600; color: var(--secondary); }
        select, input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 1em; }
        .btn-group { display: flex; justify-content: space-between; margin-top: 30px; }
        button { padding: 12px 25px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-next { background: var(--primary); color: white; }
        .btn-prev { background: #95a5a6; color: white; }
        .result-box { background: #e8f6ef; border-left: 5px solid var(--primary); padding: 20px; margin-top: 20px; border-radius: 4px; }
        .checklist { font-size: 0.9em; background: #fff8e1; border: 1px solid #ffe082; padding: 15px; border-radius: 6px; }
        .warning { color: #e74c3c; font-size: 0.85em; margin-top: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h1>⚡ Simulatore Conto Termico 3.0</h1>
    
    <div class="steps-indicator">
        <div id="ind-1" class="active">1. CLIENTE</div>
        <div id="ind-2">2. INTERVENTO</div>
        <div id="ind-3">3. TECNICI</div>
        <div id="ind-4">4. RISULTATO</div>
    </div>

    <!-- STEP 1: DATI CLIENTE -->
    <div class="step active" id="step-1">
        <label>Tipo Soggetto Responsabile</label>
        <select id="tipo-soggetto">
            <option value="privato">Privato / Condominio</option>
            <option value="pa">Pubblica Amministrazione</option>
        </select>

        <label>Zona Climatica (Comune)</label>
        <select id="zona-climatica">
            <option value="600">Zona A (600 ore)</option>
            <option value="850">Zona B (850 ore)</option>
            <option value="1100">Zona C (1100 ore)</option>
            <option value="1400">Zona D (1400 ore)</option>
            <option value="1700">Zona E (1700 ore)</option>
            <option value="1800">Zona F (1800 ore)</option>
        </select>
        <div class="btn-group">
            <span></span>
            <button class="btn-next" onclick="changeStep(2)">Avanti</button>
        </div>
    </div>

    <!-- STEP 2: TIPO INTERVENTO -->
    <div class="step" id="step-2">
        <label>Tipologia di Intervento GSE</label>
        <select id="categoria-intervento" onchange="filterProducts()">
            <option value="">Seleziona...</option>
            <option value="2A">2.A Pompe di Calore (Aria/Acqua, Aria/Aria)</option>
            <option value="2D">2.D Scaldacqua a Pompa di Calore</option>
            <option value="2E">2.E Sistemi Ibridi Factory Made</option>
        </select>
        <div class="btn-group">
            <button class="btn-prev" onclick="changeStep(1)">Indietro</button>
            <button class="btn-next" onclick="changeStep(3)">Avanti</button>
        </div>
    </div>

    <!-- STEP 3: DATI TECNICI -->
    <div class="step" id="step-3">
        <label>Seleziona Prodotto dal Catalogo</label>
        <select id="prodotto-selezionato">
            <!-- Popolato dinamicamente -->
        </select>

        <label>Spesa Totale Preventivata (€ IVA inclusa)</label>
        <input type="number" id="spesa-totale" placeholder="Es: 5000">
        
        <div class="btn-group">
            <button class="btn-prev" onclick="changeStep(2)">Indietro</button>
            <button class="btn-next" onclick="calculate()">Calcola Incentivo</button>
        </div>
    </div>

    <!-- STEP 4: CALCOLO E RIEPILOGO -->
    <div class="step" id="step-4">
        <div class="result-box">
            <h3>Risultato della Simulazione</h3>
            <p>Incentivo Totale Stimato: <strong id="res-incentivo" style="font-size: 1.4em;">€ 0,00</strong></p>
            <p>Costo Netto per il Cliente: <span id="res-costo-netto">€ 0,00</span></p>
            <p>Modalità Erogazione: <strong id="res-rata">Unica rata (entro 90gg)</strong></p>
        </div>

        <h4>Checklist Pratica GSE (Obbligatoria)</h4>
        <div class="checklist">
            <input type="checkbox" checked disabled> Foto targa generatore sostituito (Ante-Operam) [3]<br>
            <input type="checkbox" checked disabled> Foto targa nuovo generatore installato [4]<br>
            <input type="checkbox" checked disabled> Certificato smaltimento vecchio impianto [5]<br>
            <input type="checkbox" checked disabled> Fatture e Bonifici con causale specifica [6]<br>
            <input type="checkbox" checked disabled> Libretto d'impianto aggiornato [7]
        </div>

        <div class="btn-group">
            <button class="btn-prev" onclick="changeStep(3)">Modifica</button>
            <button class="btn-next" onclick="window.print()">Stampa PDF</button>
        </div>
    </div>
</div>

<script>
// DATABASE PRODOTTI ESTRATTO DAI CATALOGHI ALLEGATI [8-11]
const catalog = [
    // Pompe di Calore (2.A)
    { id: 1, cat: "2A", marca: "AERMEC", mod: "HMI 100", pn: 10.10, cop: 4.63, ci: 0.16 },
    { id: 2, cat: "2A", marca: "ARISTON", mod: "NIMBUS POCKET 150 R32", pn: 15.00, cop: 4.70, ci: 0.11 },
    { id: 3, cat: "2A", marca: "DAIKIN", mod: "Altherma 3 H HT 16kW", pn: 11.60, cop: 4.50, ci: 0.16 },
    // Scaldacqua (2.D)
    { id: 4, cat: "2D", marca: "ARISTON", mod: "NUOS PLUS 250 (Basamento)", pn: 2.35, cop: 3.35, ci: 0.40, limit: 1500 },
    { id: 5, cat: "2D", marca: "AERMEC", mod: "SWP 301 (Murale)", pn: 1.95, cop: 2.91, ci: 0.40, limit: 700 },
    // Sistemi Ibridi (2.E) - k coefficiente 1.25 [12]
    { id: 6, cat: "2E", marca: "ATAG", mod: "ENERGION ODM 50 i35", pn: 5.00, cop: 5.00, ci: 0.150, k: 1.25 },
    { id: 7, cat: "2E", marca: "BIASI", mod: "ADATTA 08 MONO", pn: 8.41, cop: 4.62, ci: 0.150, k: 1.25 }
];

function changeStep(step) {
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.steps-indicator div').forEach(i => i.classList.remove('active'));
    document.getElementById('step-' + step).classList.add('active');
    document.getElementById('ind-' + step).classList.add('active');
}

function filterProducts() {
    const cat = document.getElementById('categoria-intervento').value;
    const select = document.getElementById('prodotto-selezionato');
    select.innerHTML = '<option value="">-- Seleziona Modello --</option>';
    
    catalog.filter(p => p.cat === cat).forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.text = `${p.marca} - ${p.mod} (${p.pn} kWt)`;
        select.appendChild(opt);
    });
}

function calculate() {
    const prodId = document.getElementById('prodotto-selezionato').value;
    const spesa = parseFloat(document.getElementById('spesa-totale').value) || 0;
    const quf = parseFloat(document.getElementById('zona-climatica').value);
    
    if (!prodId || spesa <= 0) {
        alert("Inserire tutti i dati tecnici e la spesa.");
        return;
    }

    const prod = catalog.find(p => p.id == prodId);
    let incentivoTotale = 0;

    if (prod.cat === "2A" || prod.cat === "2E") {
        // FORMULA GSE: Pn * Quf * Ci * (1 - 1/COP) [13, 14]
        let ia_tot = prod.pn * quf * prod.ci * (1 - (1 / prod.cop));
        
        // Applica coefficiente k=1.25 per Ibridi [12]
        if (prod.cat === "2E") ia_tot = ia_tot * prod.k;
        
        // Erogazione in 2 anni per Pn <= 35kW [12]
        incentivoTotale = ia_tot * 2;
    } 
    else if (prod.cat === "2D") {
        // FORMULA SCALDACQUA: 40% della spesa con tetti massimi [12, 15]
        incentivoTotale = Math.min(spesa * 0.40, prod.limit);
    }

    // REGOLA DEL 65%: L'incentivo non può superare il 65% della spesa [15, 16]
    const cap65 = spesa * 0.65;
    if (incentivoTotale > cap65) {
        incentivoTotale = cap65;
    }

    // Visualizzazione Risultati
    document.getElementById('res-incentivo').innerText = "€ " + incentivoTotale.toLocaleString('it-IT', {minimumFractionDigits: 2});
    document.getElementById('res-costo-netto').innerText = "€ " + (spesa - incentivoTotale).toLocaleString('it-IT', {minimumFractionDigits: 2});
    
    // Regola Rata Unica: Sotto i 15.000€ rata unica [15]
    document.getElementById('res-rata').innerText = incentivoTotale <= 15000 ? "Unica Rata (entro 90gg)" : "Rate annuali (2 o 5 anni)";

    changeStep(4);
}
</script>

</body>
</html>
