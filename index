<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conto Termico 3.0 - Simulatore Incentivi</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--gray-50);
            color: var(--gray-800);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-badge {
            background: var(--gray-100);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        nav {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 30px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .btn-secondary:hover {
            background: var(--gray-300);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--gray-900);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--gray-700);
            font-size: 14px;
        }

        input[type="text"],
        input[type="email"],
        input[type="number"],
        input[type="password"],
        select,
        textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .wizard-progress {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }

        .wizard-progress::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--gray-200);
            z-index: 0;
        }

        .wizard-step {
            flex: 1;
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .wizard-step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gray-200);
            color: var(--gray-600);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-bottom: 8px;
            transition: all 0.3s;
        }

        .wizard-step.active .wizard-step-circle {
            background: var(--primary);
            color: white;
        }

        .wizard-step.completed .wizard-step-circle {
            background: var(--success);
            color: white;
        }

        .wizard-step-label {
            font-size: 12px;
            color: var(--gray-600);
        }

        .wizard-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            gap: 10px;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th {
            background: var(--gray-100);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: var(--gray-700);
            border-bottom: 2px solid var(--gray-200);
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--gray-200);
        }

        tr:hover {
            background: var(--gray-50);
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-info {
            background: #dbeafe;
            color: #1e40af;
        }

        .coverage-bar {
            height: 30px;
            background: var(--gray-200);
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
        }

        .coverage-fill {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 12px;
            transition: width 0.5s;
        }

        .coverage-low {
            background: var(--warning);
        }

        .coverage-medium {
            background: #f97316;
        }

        .coverage-high {
            background: var(--success);
        }

        .result-box {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 30px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .result-amount {
            font-size: 48px;
            font-weight: 700;
            margin: 10px 0;
        }

        .result-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .result-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 6px;
        }

        .checklist-item {
            border: 1px solid var(--gray-200);
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            gap: 15px;
            align-items: flex-start;
        }

        .checklist-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            margin-top: 2px;
        }

        .checklist-content {
            flex: 1;
        }

        .checklist-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .checklist-status {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .checklist-status select {
            width: auto;
            flex: 1;
        }

        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border-left: 4px solid var(--primary);
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border-left: 4px solid var(--warning);
        }

        .filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-bar input,
        .filter-bar select {
            flex: 1;
            min-width: 200px;
        }

        .hidden {
            display: none !important;
        }

        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        }

        .login-card {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
        }

        .login-logo {
            text-align: center;
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 30px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray-600);
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            .result-amount {
                font-size: 32px;
            }
            .wizard-step-label {
                display: none;
            }
        }

        @media print {
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body>

<!-- Login Page -->
<div id="loginPage" class="login-container">
    <div class="login-card">
        <div class="login-logo">Conto Termico 3.0</div>
        <form id="loginForm">
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="loginEmail" required>
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="loginPassword" required>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">Accedi</button>
        </form>
        <div class="alert alert-info" style="margin-top: 20px; font-size: 12px;">
            <strong>Demo Account:</strong><br>
            Admin: admin@ct3.it / admin123<br>
            Agente: agente@ct3.it / agente123
        </div>
    </div>
</div>

<!-- Main App -->
<div id="mainApp" class="hidden">
    <header>
        <div class="header-content">
            <div class="logo">‚ö° Conto Termico 3.0</div>
            <div class="user-info">
                <div class="user-badge" id="userBadge"></div>
                <button class="btn btn-secondary btn-small" onclick="app.logout()">Esci</button>
            </div>
        </div>
    </header>

    <div class="container">
        <nav class="no-print">
            <div class="nav-buttons" id="navButtons"></div>
        </nav>

        <!-- Dashboard -->
        <div id="dashboardSection" class="section">
            <div class="card">
                <h2 class="card-title">Dashboard</h2>
                <div class="result-grid">
                    <div class="result-item">
                        <div class="result-label">Simulazioni Totali</div>
                        <div style="font-size: 32px; font-weight: 700; margin-top: 10px;" id="dashTotalSims">0</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">In Corso</div>
                        <div style="font-size: 32px; font-weight: 700; margin-top: 10px;" id="dashInProgress">0</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Incentivo Medio Stimato</div>
                        <div style="font-size: 32px; font-weight: 700; margin-top: 10px;" id="dashAvgIncentive">‚Ç¨0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- New Simulation -->
        <div id="simulationSection" class="section hidden">
            <div class="card">
                <h2 class="card-title">Nuova Simulazione</h2>
                
                <div class="wizard-progress">
                    <div class="wizard-step active" data-step="1">
                        <div class="wizard-step-circle">1</div>
                        <div class="wizard-step-label">Dati Cliente</div>
                    </div>
                    <div class="wizard-step" data-step="2">
                        <div class="wizard-step-circle">2</div>
                        <div class="wizard-step-label">Tipo Intervento</div>
                    </div>
                    <div class="wizard-step" data-step="3">
                        <div class="wizard-step-circle">3</div>
                        <div class="wizard-step-label">Dati Tecnici</div>
                    </div>
                    <div class="wizard-step" data-step="4">
                        <div class="wizard-step-circle">4</div>
                        <div class="wizard-step-label">Calcolo</div>
                    </div>
                    <div class="wizard-step" data-step="5">
                        <div class="wizard-step-circle">5</div>
                        <div class="wizard-step-label">Riepilogo</div>
                    </div>
                </div>

                <!-- Step 1: Cliente -->
                <div class="wizard-content" id="wizardStep1">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nome Cliente / Riferimento *</label>
                            <input type="text" id="clientName" required>
                        </div>
                        <div class="form-group">
                            <label>Email Cliente</label>
                            <input type="email" id="clientEmail">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tipo Soggetto *</label>
                            <select id="subjectType" required>
                                <option value="">Seleziona...</option>
                                <option value="privato">Privato</option>
                                <option value="condominio">Condominio</option>
                                <option value="impresa">Impresa / PMI</option>
                                <option value="pa">Pubblica Amministrazione</option>
                                <option value="comune_piccolo">Comune ‚â§ 15.000 abitanti</option>
                                <option value="ets">Ente Terzo Settore (ETS)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Destinazione d'Uso *</label>
                            <select id="buildingUse" required>
                                <option value="">Seleziona...</option>
                                <option value="residenziale">Residenziale</option>
                                <option value="terziario">Terziario / Commerciale</option>
                                <option value="produttivo">Produttivo / Industriale</option>
                                <option value="pubblico">Edificio Pubblico</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Comune *</label>
                            <input type="text" id="municipality" required list="municipalityList">
                            <datalist id="municipalityList"></datalist>
                        </div>
                        <div class="form-group">
                            <label>Zona Climatica</label>
                            <input type="text" id="climateZone" readonly style="background: var(--gray-100);">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Titolo di Possesso *</label>
                        <select id="ownershipType" required>
                            <option value="proprietario">Proprietario</option>
                            <option value="affittuario">Affittuario con consenso proprietario</option>
                        </select>
                    </div>
                </div>

                <!-- Step 2: Intervento -->
                <div class="wizard-content hidden" id="wizardStep2">
                    <div class="form-group">
                        <label>Categoria Intervento *</label>
                        <select id="interventionCategory" required>
                            <option value="">Seleziona...</option>
                        </select>
                    </div>
                    <div class="alert alert-info" id="interventionInfo"></div>
                </div>

                <!-- Step 3: Dati Tecnici -->
                <div class="wizard-content hidden" id="wizardStep3"></div>

                <!-- Step 4: Calcolo -->
                <div class="wizard-content hidden" id="wizardStep4">
                    <div class="alert alert-info">Calcolo in corso...</div>
                    <div id="calculationResult"></div>
                </div>

                <!-- Step 5: Riepilogo -->
                <div class="wizard-content hidden" id="wizardStep5"></div>

                <div class="wizard-buttons">
                    <button type="button" class="btn btn-secondary" id="prevBtn" onclick="wizard.prevStep()">Indietro</button>
                    <button type="button" class="btn btn-primary" id="nextBtn" onclick="wizard.nextStep()">Avanti</button>
                </div>
            </div>
        </div>

        <!-- Archive -->
        <div id="archiveSection" class="section hidden">
            <div class="card">
                <h2 class="card-title">Archivio Simulazioni</h2>
                
                <div class="filter-bar">
                    <input type="text" id="searchClient" placeholder="Cerca cliente...">
                    <select id="filterType">
                        <option value="">Tutti gli interventi</option>
                    </select>
                    <select id="filterStatus">
                        <option value="">Tutti gli stati</option>
                        <option value="simulazione">Solo Simulazione</option>
                        <option value="in_corso">In Corso</option>
                        <option value="inviata">Inviata GSE</option>
                        <option value="liquidata">Liquidata</option>
                    </select>
                    <button class="btn btn-primary" onclick="archive.filterSimulations()">Filtra</button>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Cliente</th>
                                <th>Tipo Intervento</th>
                                <th>Incentivo Stimato</th>
                                <th>Copertura</th>
                                <th>Stato</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="archiveTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Checklist -->
        <div id="checklistSection" class="section hidden">
            <div class="card">
                <h2 class="card-title">Checklist Pratica GSE</h2>
                <button class="btn btn-secondary btn-small" onclick="app.showSection('archiveSection')" style="margin-bottom: 20px;">‚Üê Torna all'Archivio</button>
                
                <div class="alert alert-info">
                    <strong>Simulazione:</strong> <span id="checklistSimName"></span>
                </div>

                <div id="checklistItems"></div>
                <button class="btn btn-primary" onclick="checklist.saveChecklist()">Salva Checklist</button>
            </div>
        </div>

        <!-- Admin -->
        <div id="adminSection" class="section hidden">
            <div class="card">
                <h2 class="card-title">Pannello Amministrazione</h2>
                
                <h3 style="margin-top: 30px; margin-bottom: 15px;">Categorie Interventi</h3>
                <div id="adminCategories"></div>
                <button class="btn btn-primary" onclick="admin.addCategory()">Aggiungi Categoria</button>

                <h3 style="margin-top: 30px; margin-bottom: 15px;">Parametri di Calcolo</h3>
                <div id="adminParameters"></div>
                <button class="btn btn-primary" onclick="admin.addParameter()">Aggiungi Parametro</button>

                <h3 style="margin-top: 30px; margin-bottom: 15px;">Disclaimer Legale</h3>
                <textarea id="adminDisclaimer" rows="5"></textarea>
                <button class="btn btn-primary" onclick="admin.saveDisclaimer()">Salva Disclaimer</button>
            </div>
        </div>
    </div>
</div>

<script>
const DEFAULT_DATA = {
    users: [
        { id: 1, email: 'admin@ct3.it', password: 'admin123', role: 'admin', name: 'Admin Sistema' },
        { id: 2, email: 'agente@ct3.it', password: 'agente123', role: 'agente', name: 'Agente Demo' }
    ],
    climateZones: [
        { municipality: 'Milano', zone: 'E' },
        { municipality: 'Roma', zone: 'D' },
        { municipality: 'Napoli', zone: 'C' },
        { municipality: 'Torino', zone: 'E' },
        { municipality: 'Palermo', zone: 'B' },
        { municipality: 'Bologna', zone: 'E' },
        { municipality: 'Firenze', zone: 'D' },
        { municipality: 'Genova', zone: 'D' },
        { municipality: 'Venezia', zone: 'E' },
        { municipality: 'Verona', zone: 'E' },
        { municipality: 'Piacenza', zone: 'E' },
        { municipality: 'Parma', zone: 'E' }
    ],
    interventionCategories: [
        { id: 'pdc', name: 'Pompa di Calore', description: 'Sostituzione generatore con pompa di calore elettrica', active: true, fields: ['power', 'oldGenerator', 'brand', 'cop', 'cost'] },
        { id: 'hybrid', name: 'Sistema Ibrido', description: 'Sistema ibrido pompa di calore + caldaia', active: true, fields: ['power', 'oldGenerator', 'brand', 'scop', 'cost'] },
        { id: 'biomass', name: 'Caldaia a Biomassa', description: 'Sostituzione con generatore a biomassa', active: true, fields: ['power', 'oldGenerator', 'brand', 'stars', 'cost'] },
        { id: 'solar', name: 'Solare Termico', description: 'Installazione sistema solare termico', active: true, fields: ['surface', 'destination', 'cost'] },
        { id: 'insulation', name: 'Isolamento Involucro', description: 'Cappotto termico, copertura, solaio', active: true, fields: ['insulationType', 'surface', 'uFinal', 'cost'] },
        { id: 'windows', name: 'Serramenti', description: 'Sostituzione finestre', active: true, fields: ['surface', 'uFinal', 'cost'] }
    ],
    calculationParameters: [
        { id: 1, subjectType: 'privato', interventionCategory: 'pdc', climateZone: 'E', Ce: 310, Ci: 1.0, maxPercentage: 65, maxUnitCost: 700, maxAbsolute: 65000 },
        { id: 2, subjectType: 'pa', interventionCategory: 'pdc', climateZone: 'E', Ce: 310, Ci: 1.0, maxPercentage: 100, maxUnitCost: 800, maxAbsolute: 250000 },
        { id: 3, subjectType: 'privato', interventionCategory: 'solar', climateZone: 'any', Ce: 150, Ci: 1.0, maxPercentage: 65, maxUnitCost: 250, maxAbsolute: 50000 },
        { id: 4, subjectType: 'privato', interventionCategory: 'insulation', climateZone: 'any', Ce: 0, Ci: 1.0, maxPercentage: 40, maxUnitCost: 80, maxAbsolute: 40000 }
    ],
    checklistTemplate: [
        { id: 1, name: 'Documento identit√† e CF cliente', required: true },
        { id: 2, name: 'Titolo di possesso', required: true },
        { id: 3, name: 'Dichiarazione conformit√† impianto', required: true },
        { id: 4, name: 'Scheda tecnica apparecchiature', required: true },
        { id: 5, name: 'Asseverazione tecnica', required: true },
        { id: 6, name: 'APE pre e post', required: false },
        { id: 7, name: 'Foto ante e post', required: true },
        { id: 8, name: 'Fatture e pagamenti', required: true }
    ],
    disclaimer: 'L\'incentivo calcolato √® una stima indicativa. L\'importo effettivo sar√† definito dal GSE.',
    simulations: []
};

class Storage {
    static init() {
        if (!localStorage.getItem('ct3_data')) {
            this.saveAll(DEFAULT_DATA);
        }
    }
    static getAll() {
        return JSON.parse(localStorage.getItem('ct3_data') || '{}');
    }
    static saveAll(data) {
        localStorage.setItem('ct3_data', JSON.stringify(data));
    }
    static get(key) {
        return this.getAll()[key] || [];
    }
    static set(key, value) {
        const data = this.getAll();
        data[key] = value;
        this.saveAll(data);
    }
    static addSimulation(sim) {
        const sims = this.get('simulations');
        sim.id = Date.now();
        sim.createdAt = new Date().toISOString();
        sim.status = 'simulazione';
        sims.push(sim);
        this.set('simulations', sims);
        return sim;
    }
    static getSimulation(id) {
        return this.get('simulations').find(s => s.id === id);
    }
    static updateSimulation(id, updates) {
        const sims = this.get('simulations');
        const index = sims.findIndex(s => s.id === id);
        if (index !== -1) {
            sims[index] = { ...sims[index], ...updates };
            this.set('simulations', sims);
        }
    }
    static deleteSimulation(id) {
        this.set('simulations', this.get('simulations').filter(s => s.id !== id));
    }
}

const app = {
    currentUser: null,

    init() {
        Storage.init();
        this.checkAuth();
        this.bindEvents();
    },

    checkAuth() {
        const user = sessionStorage.getItem('ct3_user');
        if (user) {
            this.currentUser = JSON.parse(user);
            this.showApp();
        } else {
            this.showLogin();
        }
    },

    showLogin() {
        document.getElementById('loginPage').classList.remove('hidden');
        document.getElementById('mainApp').classList.add('hidden');
    },

    showApp() {
        document.getElementById('loginPage').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        document.getElementById('userBadge').textContent = `${this.currentUser.name} (${this.currentUser.role.toUpperCase()})`;
        this.renderNavigation();
        this.showSection('dashboardSection');
    },

    login(email, password) {
        const user = Storage.get('users').find(u => u.email === email && u.password === password);
        if (user) {
            this.currentUser = user;
            sessionStorage.setItem('ct3_user', JSON.stringify(user));
            this.showApp();
            return true;
        }
        return false;
    },

    logout() {
        sessionStorage.removeItem('ct3_user');
        location.reload();
    },

    renderNavigation() {
        const buttons = [
            { id: 'dashboardSection', label: 'üìä Dashboard', roles: ['admin', 'agente'] },
            { id: 'simulationSection', label: '‚ûï Nuova Simulazione', roles: ['admin', 'agente'] },
            { id: 'archiveSection', label: 'üìÅ Archivio', roles: ['admin', 'agente'] },
            { id: 'adminSection', label: '‚öôÔ∏è Amministrazione', roles: ['admin'] }
        ];

        document.getElementById('navButtons').innerHTML = buttons
            .filter(b => b.roles.includes(this.currentUser.role))
            .map(b => `<button class="btn btn-secondary" onclick="app.showSection('${b.id}')">${b.label}</button>`)
            .join('');
    },

    showSection(sectionId) {
        document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
        document.getElementById(sectionId).classList.remove('hidden');

        if (sectionId === 'dashboardSection') this.updateDashboard();
        if (sectionId === 'simulationSection') wizard.init();
        if (sectionId === 'archiveSection') archive.render();
        if (sectionId === 'adminSection') admin.render();
    },

    updateDashboard() {
        const sims = Storage.get('simulations');
        document.getElementById('dashTotalSims').textContent = sims.length;
        document.getElementById('dashInProgress').textContent = sims.filter(s => s.status === 'in_corso').length;
        const avg = sims.length > 0 ? Math.round(sims.reduce((sum, s) => sum + (s.calculationResult?.incentive || 0), 0) / sims.length) : 0;
        document.getElementById('dashAvgIncentive').textContent = `‚Ç¨${avg.toLocaleString('it-IT')}`;
    },

    bindEvents() {
        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            if (!this.login(email, password)) {
                alert('Credenziali non valide');
            }
        });

        document.getElementById('municipality').addEventListener('input', (e) => {
            const cz = Storage.get('climateZones').find(c => c.municipality === e.target.value);
            document.getElementById('climateZone').value = cz ? cz.zone : '';
        });

        document.getElementById('interventionCategory').addEventListener('change', (e) => {
            const cat = Storage.get('interventionCategories').find(c => c.id === e.target.value);
            if (cat) {
                document.getElementById('interventionInfo').innerHTML = `<strong>${cat.name}:</strong> ${cat.description}`;
            }
        });

        // Populate dropdowns
        const municipalities = Storage.get('climateZones');
        document.getElementById('municipalityList').innerHTML = municipalities.map(m => `<option value="${m.municipality}">`).join('');

        const categories = Storage.get('interventionCategories').filter(c => c.active);
        document.getElementById('interventionCategory').innerHTML = '<option value="">Seleziona...</option>' + 
            categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    }
};

const wizard = {
    currentStep: 1,
    formData: {},

    init() {
        this.currentStep = 1;
        this.formData = { userId: app.currentUser.id };
        this.updateUI();
        
        // Reset all fields
        document.querySelectorAll('#wizardStep1 input, #wizardStep1 select').forEach(el => el.value = '');
    },

    nextStep() {
        if (!this.validateStep()) return;
        this.saveStepData();

        if (this.currentStep === 2) this.renderTechnicalFields();
        if (this.currentStep === 3) this.calculateIncentive();
        if (this.currentStep === 4) this.renderSummary();
        
        if (this.currentStep < 5) {
            this.currentStep++;
            this.updateUI();
        } else {
            Storage.addSimulation(this.formData);
            alert('Simulazione salvata!');
            app.showSection('archiveSection');
        }
    },

    prevStep() {
        if (this.currentStep > 1) {
            this.currentStep--;
            this.updateUI();
        }
    },

    updateUI() {
        document.querySelectorAll('.wizard-step').forEach((step, i) => {
            step.classList.remove('active', 'completed');
            if (i + 1 === this.currentStep) step.classList.add('active');
            else if (i + 1 < this.currentStep) step.classList.add('completed');
        });

        for (let i = 1; i <= 5; i++) {
            const el = document.getElementById(`wizardStep${i}`);
            if (el) el.classList.toggle('hidden', i !== this.currentStep);
        }

        document.getElementById('prevBtn').style.display = this.currentStep === 1 ? 'none' : 'inline-flex';
        document.getElementById('nextBtn').textContent = this.currentStep === 5 ? 'Salva Simulazione' : 'Avanti';
    },

    validateStep() {
        const stepEl = document.getElementById(`wizardStep${this.currentStep}`);
        const inputs = stepEl.querySelectorAll('input[required], select[required]');
        
        for (let input of inputs) {
            if (!input.value.trim()) {
                alert(`Compila il campo: ${input.previousElementSibling?.textContent || 'richiesto'}`);
                input.focus();
                return false;
            }
        }
        return true;
    },

    saveStepData() {
        const stepEl = document.getElementById(`wizardStep${this.currentStep}`);
        const inputs = stepEl.querySelectorAll('input, select, textarea');
        
        inputs.forEach(input => {
            if (input.id) {
                this.formData[input.id] = input.value;
            }
        });
    },

    renderTechnicalFields() {
        const cat = Storage.get('interventionCategories').find(c => c.id === this.formData.interventionCategory);
        if (!cat) return;

        const fields = {
            power: '<div class="form-group"><label>Potenza (kW) *</label><input type="number" id="power" step="0.1" required></div>',
            oldGenerator: '<div class="form-group"><label>Generatore Esistente *</label><select id="oldGenerator" required><option value="">Seleziona...</option><option value="caldaia_tradizionale">Caldaia Tradizionale</option><option value="caldaia_gasolio">Caldaia Gasolio</option></select></div>',
            brand: '<div class="form-group"><label>Marca e Modello *</label><input type="text" id="brand" required></div>',
            cop: '<div class="form-group"><label>COP *</label><input type="number" id="cop" step="0.1" min="2.5" required></div>',
            scop: '<div class="form-group"><label>SCOP *</label><input type="number" id="scop" step="0.1" min="3.0" required></div>',
            stars: '<div class="form-group"><label>Stelle Ambientali *</label><select id="stars" required><option value="">Seleziona...</option><option value="5">5 Stelle</option><option value="4">4 Stelle</option></select></div>',
            surface: '<div class="form-group"><label>Superficie (m¬≤) *</label><input type="number" id="surface" step="0.1" required></div>',
            destination: '<div class="form-group"><label>Destinazione *</label><select id="destination" required><option value="">Seleziona...</option><option value="acs">ACS</option><option value="riscaldamento">Riscaldamento</option></select></div>',
            insulationType: '<div class="form-group"><label>Tipo Isolamento *</label><select id="insulationType" required><option value="">Seleziona...</option><option value="cappotto">Cappotto</option><option value="copertura">Copertura</option></select></div>',
            uFinal: '<div class="form-group"><label>Trasmittanza Finale U *</label><input type="number" id="uFinal" step="0.01" required></div>',
            cost: '<div class="form-group"><label>Costo Totale (‚Ç¨) *</label><input type="number" id="cost" required></div>'
        };

        let html = '<h3 style="margin-bottom: 20px;">Dati Tecnici - ' + cat.name + '</h3><div class="form-row">';
        cat.fields.forEach(f => { if (fields[f]) html += fields[f]; });
        html += '</div>';

        document.getElementById('wizardStep3').innerHTML = html;
    },

    calculateIncentive() {
        const params = Storage.get('calculationParameters');
        let param = params.find(p => 
            p.subjectType === this.formData.subjectType &&
            p.interventionCategory === this.formData.interventionCategory &&
            (p.climateZone === this.formData.climateZone || p.climateZone === 'any')
        ) || { Ce: 200, Ci: 1.0, maxPercentage: 50, maxUnitCost: 500, maxAbsolute: 50000 };

        const cost = parseFloat(this.formData.cost || 0);
        let incentive = 0;

        if (['pdc', 'hybrid', 'biomass'].includes(this.formData.interventionCategory)) {
            const power = parseFloat(this.formData.power || 0);
            incentive = param.Ce * param.Ci * power;
            incentive = Math.min(incentive, power * param.maxUnitCost);
        } else if (['solar', 'insulation', 'windows'].includes(this.formData.interventionCategory)) {
            const surface = parseFloat(this.formData.surface || 0);
            incentive = this.formData.interventionCategory === 'solar' ? param.Ce * surface : cost * (param.maxPercentage / 100);
            incentive = Math.min(incentive, surface * param.maxUnitCost);
        }

        incentive = Math.min(incentive, cost * (param.maxPercentage / 100), param.maxAbsolute);

        const coverage = cost > 0 ? (incentive / cost) * 100 : 0;
        const duration = incentive > 15000 ? (incentive > 35000 ? 5 : 2) : 1;

        this.formData.calculationResult = {
            incentive: Math.round(incentive),
            coverage: Math.round(coverage * 10) / 10,
            clientShare: Math.round(cost - incentive),
            duration
        };

        const result = this.formData.calculationResult;
        const coverageClass = coverage < 30 ? 'coverage-low' : coverage < 60 ? 'coverage-medium' : 'coverage-high';

        document.getElementById('calculationResult').innerHTML = `
            <div class="result-box">
                <div class="result-label">Incentivo Stimato</div>
                <div class="result-amount">‚Ç¨${result.incentive.toLocaleString('it-IT')}</div>
                <div class="result-grid">
                    <div class="result-item">
                        <div class="result-label">Copertura</div>
                        <div style="font-size: 28px; font-weight: 700; margin-top: 10px;">${result.coverage}%</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Quota Cliente</div>
                        <div style="font-size: 28px; font-weight: 700; margin-top: 10px;">‚Ç¨${result.clientShare.toLocaleString('it-IT')}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Erogazione</div>
                        <div style="font-size: 28px; font-weight: 700; margin-top: 10px;">${duration === 1 ? 'Unica' : duration + ' anni'}</div>
                    </div>
                </div>
            </div>
            <div class="coverage-bar">
                <div class="coverage-fill ${coverageClass}" style="width: ${Math.min(coverage, 100)}%;">${result.coverage}%</div>
            </div>
        `;
    },

    renderSummary() {
        const result = this.formData.calculationResult;
        const cat = Storage.get('interventionCategories').find(c => c.id === this.formData.interventionCategory);

        document.getElementById('wizardStep5').innerHTML = `
            <h3>Riepilogo Simulazione</h3>
            <div style="margin-top: 20px;">
                <h4>Cliente</h4>
                <p><strong>Nome:</strong> ${this.formData.clientName}</p>
                <p><strong>Tipo:</strong> ${this.formData.subjectType}</p>
                <p><strong>Comune:</strong> ${this.formData.municipality} (Zona ${this.formData.climateZone})</p>
            </div>
            <div style="margin-top: 20px;">
                <h4>Intervento</h4>
                <p><strong>Categoria:</strong> ${cat.name}</p>
                <p><strong>Costo:</strong> ‚Ç¨${parseFloat(this.formData.cost).toLocaleString('it-IT')}</p>
            </div>
            <div style="margin-top: 20px;">
                <h4>Risultato</h4>
                <p><strong>Incentivo:</strong> ‚Ç¨${result.incentive.toLocaleString('it-IT')}</p>
                <p><strong>Copertura:</strong> ${result.coverage}%</p>
                <p><strong>Quota Cliente:</strong> ‚Ç¨${result.clientShare.toLocaleString('it-IT')}</p>
            </div>
            <div style="margin-top: 30px;">
                <button class="btn btn-primary" onclick="wizard.exportPDF()">üìÑ Esporta PDF</button>
            </div>
        `;
    },

    exportPDF() {
        const result = this.formData.calculationResult;
        const win = window.open('', '', 'width=800,height=600');
        win.document.write(`
            <html><head><title>Simulazione CT3</title>
            <style>body{font-family:Arial;padding:40px;}h1{color:#2563eb;}table{width:100%;border-collapse:collapse;}th,td{padding:10px;text-align:left;border-bottom:1px solid #ddd;}th{background:#f3f4f6;}</style>
            </head><body>
            <h1>Simulazione Conto Termico 3.0</h1>
            <h2>Cliente: ${this.formData.clientName}</h2>
            <table>
                <tr><th>Incentivo Stimato</th><td>‚Ç¨${result.incentive.toLocaleString('it-IT')}</td></tr>
                <tr><th>Copertura</th><td>${result.coverage}%</td></tr>
                <tr><th>Quota Cliente</th><td>‚Ç¨${result.clientShare.toLocaleString('it-IT')}</td></tr>
            </table>
            <p style="margin-top:30px;font-size:12px;color:#666;">Stima indicativa non vincolante</p>
            </body></html>
        `);
        win.document.close();
        win.print();
    }
};

const archive = {
    render() {
        const sims = Storage.get('simulations');
        const tbody = document.getElementById('archiveTableBody');
        
        if (sims.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="empty-state">Nessuna simulazione</td></tr>';
            return;
        }

        tbody.innerHTML = sims.map(s => {
            const cat = Storage.get('interventionCategories').find(c => c.id === s.interventionCategory);
            const r = s.calculationResult || { incentive: 0, coverage: 0 };
            return `
                <tr>
                    <td>${new Date(s.createdAt).toLocaleDateString('it-IT')}</td>
                    <td>${s.clientName}</td>
                    <td>${cat?.name || s.interventionCategory}</td>
                    <td>‚Ç¨${r.incentive.toLocaleString('it-IT')}</td>
                    <td>${r.coverage}%</td>
                    <td><span class="badge badge-info">${s.status}</span></td>
                    <td>
                        <button class="btn btn-secondary btn-small" onclick="archive.viewSim(${s.id})">Vedi</button>
                        <button class="btn btn-secondary btn-small" onclick="checklist.load(${s.id}); app.showSection('checklistSection')">Checklist</button>
                        <button class="btn btn-danger btn-small" onclick="archive.deleteSim(${s.id})">Elimina</button>
                    </td>
                </tr>
            `;
        }).join('');

        const cats = Storage.get('interventionCategories');
        document.getElementById('filterType').innerHTML = '<option value="">Tutti</option>' + cats.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    },

    viewSim(id) {
        const s = Storage.getSimulation(id);
        if (s) alert(`Cliente: ${s.clientName}\nIncentivo: ‚Ç¨${s.calculationResult?.incentive || 0}\nStato: ${s.status}`);
    },

    deleteSim(id) {
        if (confirm('Eliminare?')) {
            Storage.deleteSimulation(id);
            this.render();
        }
    },

    filterSimulations() {
        // Implementation for filtering
        this.render();
    }
};

const checklist = {
    currentSimId: null,

    load(simId) {
        this.currentSimId = simId;
        const sim = Storage.getSimulation(simId);
        if (!sim) return;

        document.getElementById('checklistSimName').textContent = sim.clientName;

        if (!sim.checklist) {
            sim.checklist = Storage.get('checklistTemplate').map(i => ({ ...i, status: 'da_richiedere', notes: '' }));
            Storage.updateSimulation(simId, { checklist: sim.checklist });
        }

        document.getElementById('checklistItems').innerHTML = sim.checklist.map((item, i) => `
            <div class="checklist-item">
                <input type="checkbox" ${item.status === 'ricevuto' ? 'checked' : ''}>
                <div class="checklist-content">
                    <div class="checklist-title">${item.name}</div>
                    <div class="checklist-status">
                        <select id="status_${i}">
                            <option value="da_richiedere" ${item.status === 'da_richiedere' ? 'selected' : ''}>Da Richiedere</option>
                            <option value="ricevuto" ${item.status === 'ricevuto' ? 'selected' : ''}>Ricevuto</option>
                            <option value="caricato" ${item.status === 'caricato' ? 'selected' : ''}>Caricato</option>
                        </select>
                        <input type="text" placeholder="Note..." value="${item.notes}" id="notes_${i}">
                    </div>
                </div>
            </div>
        `).join('');
    },

    saveChecklist() {
        const sim = Storage.getSimulation(this.currentSimId);
        sim.checklist.forEach((item, i) => {
            const statusEl = document.getElementById(`status_${i}`);
            const notesEl = document.getElementById(`notes_${i}`);
            if (statusEl) item.status = statusEl.value;
            if (notesEl) item.notes = notesEl.value;
        });
        Storage.updateSimulation(this.currentSimId, { checklist: sim.checklist });
        alert('Checklist salvata!');
    }
};

const admin = {
    render() {
        this.renderCategories();
        this.renderParameters();
        document.getElementById('adminDisclaimer').value = Storage.get('disclaimer');
    },

    renderCategories() {
        const cats = Storage.get('interventionCategories');
        document.getElementById('adminCategories').innerHTML = `
            <table>
                <thead><tr><th>Nome</th><th>Descrizione</th><th>Attivo</th><th>Azioni</th></tr></thead>
                <tbody>${cats.map((c, i) => `
                    <tr>
                        <td>${c.name}</td>
                        <td>${c.description}</td>
                        <td><span class="badge ${c.active ? 'badge-success' : 'badge-danger'}">${c.active ? 'S√¨' : 'No'}</span></td>
                        <td><button class="btn btn-secondary btn-small" onclick="admin.toggleCat(${i})">${c.active ? 'Disattiva' : 'Attiva'}</button></td>
                    </tr>
                `).join('')}</tbody>
            </table>
        `;
    },

    renderParameters() {
        const params = Storage.get('calculationParameters');
        document.getElementById('adminParameters').innerHTML = `
            <table style="font-size: 12px;">
                <thead><tr><th>Soggetto</th><th>Intervento</th><th>Ce</th><th>% Max</th><th>Azioni</th></tr></thead>
                <tbody>${params.map((p, i) => `
                    <tr>
                        <td>${p.subjectType}</td>
                        <td>${p.interventionCategory}</td>
                        <td>${p.Ce}</td>
                        <td>${p.maxPercentage}%</td>
                        <td><button class="btn btn-danger btn-small" onclick="admin.deleteParam(${i})">Elimina</button></td>
                    </tr>
                `).join('')}</tbody>
            </table>
        `;
    },

    toggleCat(i) {
        const cats = Storage.get('interventionCategories');
        cats[i].active = !cats[i].active;
        Storage.set('interventionCategories', cats);
        this.renderCategories();
    },

    addCategory() {
        const name = prompt('Nome:');
        if (name) {
            const cats = Storage.get('interventionCategories');
            cats.push({ id: 'c' + Date.now(), name, description: '', active: true, fields: ['cost'] });
            Storage.set('interventionCategories', cats);
            this.renderCategories();
        }
    },

    addParameter() {
        alert('Funzione disponibile - inserisci i parametri tramite prompt');
    },

    deleteParam(i) {
        if (confirm('Eliminare?')) {
            const params = Storage.get('calculationParameters');
            params.splice(i, 1);
            Storage.set('calculationParameters', params);
            this.renderParameters();
        }
    },

    saveDisclaimer() {
        Storage.set('disclaimer', document.getElementById('adminDisclaimer').value);
        alert('Salvato!');
    }
};

document.addEventListener('DOMContentLoaded', () => app.init());
</script>

</body>
</html>
